import { BehaviorSubject, from, of } from "rxjs";
import { catchError, map, mergeMap, retry, switchMap, tap, timeout } from "rxjs/operators";
import { tokenList, tokenListByAddress } from "../constants/tokens";
import { addressKeyFind } from '../utils/misc';
import { BigNumber } from 'bignumber.js'
import { KLAYSWAP_DUMMY_DATA } from "../constants/dummy";
import { _fetchKlayswapInfo$ } from "./externalInfo";

export const kokonutInvalid$ = new BehaviorSubject(false)



export const fetchKlayswapInfo$ = () => from(
  fetch("https://kleva-data.s3.ap-northeast-2.amazonaws.com/klayswap-aggregation.json").then((res) => res.json())
).pipe(
  timeout(8000),
  retry(10),
  catchError((err) => {
    console.log(err, '@err')
    return _fetchKlayswapInfo$()
  })
)

const KOKONUT_DUMMY_DATA = { "pools": [{ "address": "0x65b9F5b38B68D7F9b90a75259e18388B20799805", "symbol": "KOKO-oETH/synETH", "poolType": "BASE_POOL", "lpTokenAddress": "0xED907227C11500D9A00b73B1c51Ca2aD7CDd06cB", "coins": ["0x34d21b1e550D73cee41151c77F3c73359527a396", "0xCD6f29dC9Ca217d0973d3D21bF58eDd3CA871a86"], "coinsUnderlying": [], "adminFee": "0.6666666666", "swapFee": "0.0006000000", "deprecated": false, "liquidity": [{ "coin": "0x34d21b1e550D73cee41151c77F3c73359527a396", "amount": "1412.303819619670189239" }, { "coin": "0xCD6f29dC9Ca217d0973d3D21bF58eDd3CA871a86", "amount": "1295.018594486334387079" }], "tvl": "4568532.342963173151733391", "lpTokenVirtualPrice": "1.000004396799952308", "lpTokenRealPrice": "1687.487893733149986783", "lpTokenTotalSupply": "2707.297847841992055329", "volume24hr": "7358.689858995251565944", "volume24hrOnlySwap": "0.000000000000000000", "rewardFee24hr": "0.705284865332319829", "baseApr": "0.01", "user": null }, { "address": "0xb0Da0BBE0a13C2c17178aEa2fEC91AA08157F299", "symbol": "4NUTS", "poolType": "BASE_POOL", "lpTokenAddress": "0x22e3aC1e6595B64266e0b062E01faE31d9cdD578", "stakingPoolAddress": "0x05949D8B3ca75714CbD3a825609106e4AE9C626F", "managerAddress": "0xf8fF2caaA06Cc65b714C4056a7368E21aeBc5eC6", "coins": ["0x4Fa62F1f404188CE860c8f0041d6Ac3765a72E67", "0x5c74070FDeA071359b86082bd9f9b3dEaafbe32b", "0x754288077D0fF82AF7a5317C7CB8c444D421d103", "0xceE8FAF64bB97a73bb51E115Aa89C17FfA8dD167"], "coinsUnderlying": [], "adminFee": "0.6666666666", "swapFee": "0.0006000000", "deprecated": false, "liquidity": [{ "coin": "0x4Fa62F1f404188CE860c8f0041d6Ac3765a72E67", "amount": "1322156.260961930670833453" }, { "coin": "0x5c74070FDeA071359b86082bd9f9b3dEaafbe32b", "amount": "225999.048557347758261018" }, { "coin": "0x754288077D0fF82AF7a5317C7CB8c444D421d103", "amount": "228308.434961" }, { "coin": "0xceE8FAF64bB97a73bb51E115Aa89C17FfA8dD167", "amount": "210341.959957" }], "tvl": "1976724.850934305472442503", "lpTokenVirtualPrice": "1.017112938111290460", "lpTokenRealPrice": "1.012768873910183582", "lpTokenTotalSupply": "1951802.530524461383998682", "volume24hr": "1432473.623571639671681568", "volume24hrOnlySwap": "1283130.809063437496264089", "rewardFee24hr": "268.998253271076866932", "baseApr": "4.97", "stakingApr": "0.82", "user": null }, { "address": "0x3a15884903a7D4eF82905a608431E677f6E33306", "symbol": "KLAY-AKLAY", "poolType": "BASE_POOL", "lpTokenAddress": "0x2b3b40647aD8B6BA4aaab4642287e7AB6293BA27", "stakingPoolAddress": "0xc4EA21c64Ff28252761042b6dd81768fd59b82d0", "managerAddress": "0x48417A62B29BaDc4055571BF45FfA00d171f8b9A", "coins": ["0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE", "0x74BA03198FEd2b15a51AF242b9c63Faf3C8f4D34"], "coinsUnderlying": [], "adminFee": "0.5000000000", "swapFee": "0.0030000000", "deprecated": false, "liquidity": [{ "coin": "0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE", "amount": "2813618.640943799379628275" }, { "coin": "0x74BA03198FEd2b15a51AF242b9c63Faf3C8f4D34", "amount": "3302626.114763864946141429" }], "tvl": "1395232.004083423308363096", "lpTokenVirtualPrice": "1.075683663163128645", "lpTokenRealPrice": "0.245399421316649872", "lpTokenTotalSupply": "5685555.396168163419733017", "volume24hr": "5798.569901400996731680", "volume24hrOnlySwap": "5798.569901400996731680", "rewardFee24hr": "8.724026932900196296", "baseApr": "0.23", "stakingApr": "0.00", "aklayApr": "3.54", "user": null }, { "address": "0x7a5987c8c48F6C82632aCEF383E5fb5DB23C0027", "symbol": "KLAY-KSD", "poolType": "CRYPTO_POOL", "lpTokenAddress": "0xe995b4A0289C33A28A1F14eB7b306387dE71eB0E", "stakingPoolAddress": "0x65Ee8d0BdB899d5222EcD99b1FAF96805703720E", "managerAddress": "0x40b4d1e8aCa3C69125385Cb311479c4aAeF8CD7A", "coins": ["0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE", "0x4Fa62F1f404188CE860c8f0041d6Ac3765a72E67"], "coinsUnderlying": [], "adminFee": "0.5000000000", "swapMidFee": "0.0020000000", "swapOutFee": "0.0025000000", "deprecated": false, "liquidity": [{ "coin": "0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE", "amount": "1708285.225119980835574368" }, { "coin": "0x4Fa62F1f404188CE860c8f0041d6Ac3765a72E67", "amount": "398555.808467415777565061" }], "tvl": "785957.259163961225546011", "lpTokenVirtualPrice": "1.022167562909073438", "lpTokenRealPrice": "0.973138402291121663", "lpTokenTotalSupply": "807652.084547821808366211", "priceOracle": "4.355403580727021043", "priceScale": "4.888227087155137270", "volume24hr": "67099.654597001057291379", "volume24hrOnlySwap": "65609.449668853316979327", "rewardFee24hr": "40.881527621926260681", "baseApr": "1.90", "stakingApr": "11.06", "user": null }, { "address": "0x460c2d1E13B88965412962730115341E5234f6F5", "symbol": "KSD-oETH", "poolType": "CRYPTO_POOL", "lpTokenAddress": "0x3Cde65d7B70071bc60aB5f56709e0a00364e5Ba7", "stakingPoolAddress": "0xBD9b6b9A4d72ddbB5Ed816Cc76624A10d784eed1", "managerAddress": "0xbf420dBf0e6bD96B5590A9CFa95Bd26423921E7C", "coins": ["0x4Fa62F1f404188CE860c8f0041d6Ac3765a72E67", "0x34d21b1e550D73cee41151c77F3c73359527a396"], "coinsUnderlying": [], "adminFee": "0.5000000000", "swapMidFee": "0.0020000000", "swapOutFee": "0.0025000000", "deprecated": false, "liquidity": [{ "coin": "0x4Fa62F1f404188CE860c8f0041d6Ac3765a72E67", "amount": "57512.337519501668903266" }, { "coin": "0x34d21b1e550D73cee41151c77F3c73359527a396", "amount": "33.276642582370798883" }], "tvl": "113215.631746192429350609", "lpTokenVirtualPrice": "1.011699401333334247", "lpTokenRealPrice": "82.769569328285524565", "lpTokenTotalSupply": "1367.841256937678928774", "priceOracle": "1703.811627485855710642", "priceScale": "1598.146768593101892181", "volume24hr": "8131.846256220109846285", "volume24hrOnlySwap": "8131.845743367269891806", "rewardFee24hr": "4.464128274534369091", "baseApr": "1.44", "stakingApr": "6.74", "user": null }, { "address": "0x9bcb0E1d470592d843EE089bF5782C24f55bf8C8", "symbol": "AKLAY-KSD", "poolType": "CRYPTO_POOL", "lpTokenAddress": "0x14a31B0D3b61332E6d97f33Fe607Ab0B6e1E97BD", "managerAddress": "0x758A5025f7a64bBb0F0344c08B5a4DfB1e3f64d0", "coins": ["0x74BA03198FEd2b15a51AF242b9c63Faf3C8f4D34", "0x4Fa62F1f404188CE860c8f0041d6Ac3765a72E67"], "coinsUnderlying": [], "adminFee": "0.5000000000", "swapMidFee": "0.0020000000", "swapOutFee": "0.0025000000", "deprecated": false, "liquidity": [{ "coin": "0x74BA03198FEd2b15a51AF242b9c63Faf3C8f4D34", "amount": "98711.776117376053906756" }, { "coin": "0x4Fa62F1f404188CE860c8f0041d6Ac3765a72E67", "amount": "23024.486129335123339292" }], "tvl": "45330.157291407568734713", "lpTokenVirtualPrice": "1.011675122223374049", "lpTokenRealPrice": "0.961508128071995476", "lpTokenTotalSupply": "47144.850852486348147678", "priceOracle": "4.365231037832004854", "priceScale": "4.805331522897887000", "volume24hr": "1641.297414571622106513", "volume24hrOnlySwap": "1641.297055305795312179", "rewardFee24hr": "1.007352082525711098", "baseApr": "0.81", "aklayApr": "3.54", "user": null }, { "address": "0xea08370B52AEcB09D976f37AB3954F0E82BaeE05", "symbol": "KOKOS-KSD", "poolType": "CRYPTO_POOL", "lpTokenAddress": "0x3C3a73cc8ea3FB7597a5cC1815E3B046fb838Ac5", "stakingPoolAddress": "0x94D2b18d626310a05E993320Bb191E0593Dd3772", "managerAddress": "0x3907402688bD6801ecb27f726D7Da82290eB6Fe3", "coins": ["0xCd670d77f3dCAB82d43DFf9BD2C4b87339FB3560", "0x4Fa62F1f404188CE860c8f0041d6Ac3765a72E67"], "coinsUnderlying": [], "adminFee": "0.2000000000", "swapMidFee": "0.0080000000", "swapOutFee": "0.0120000000", "deprecated": false, "liquidity": [{ "coin": "0xCd670d77f3dCAB82d43DFf9BD2C4b87339FB3560", "amount": "1855191.832210837684466800" }, { "coin": "0x4Fa62F1f404188CE860c8f0041d6Ac3765a72E67", "amount": "20549.352391297167593557" }], "tvl": "40783.418487628790638851", "lpTokenVirtualPrice": "1.051847624200572559", "lpTokenRealPrice": "0.219706533321238968", "lpTokenTotalSupply": "185626.789841512050875444", "priceOracle": "90.967570090020183917", "priceScale": "90.331037003601109365", "volume24hr": "151.047894915826204983", "volume24hrOnlySwap": "151.028865541428439601", "rewardFee24hr": "0.493229658735029839", "baseApr": "0.44", "stakingApr": "0.00", "user": null }, { "address": "0x6104d141e6676d1b90207921B27BDfd58C20DAf7", "symbol": "KLAY-oETH", "poolType": "CRYPTO_POOL", "lpTokenAddress": "0x29B0A380da9f8d91913367e07c057C6E47cB3950", "stakingPoolAddress": "0x47f41AA7f7dB931824Ee908274fc34999Da7b155", "managerAddress": "0x253cEF46Ea4e913d858695d930d0807c374817c1", "coins": ["0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE", "0x34d21b1e550D73cee41151c77F3c73359527a396"], "coinsUnderlying": [], "adminFee": "0.5000000000", "swapMidFee": "0.0020000000", "swapOutFee": "0.0025000000", "deprecated": false, "liquidity": [{ "coin": "0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE", "amount": "61977.465309775197628126" }, { "coin": "0x34d21b1e550D73cee41151c77F3c73359527a396", "amount": "8.557130817046397762" }], "tvl": "28602.308294759496022569", "lpTokenVirtualPrice": "1.009301658108547101", "lpTokenRealPrice": "39.633839555369288690", "lpTokenTotalSupply": "721.663826054538150419", "priceOracle": "7411.241523675492514238", "priceScale": "7588.060584188002262529", "volume24hr": "1452.172906878751077515", "volume24hrOnlySwap": "1452.172906878751077515", "rewardFee24hr": "0.868987578702917200", "baseApr": "1.11", "stakingApr": "0.00", "user": null }, { "address": "0xc5075830CEA2AE5a24edDEba98315863fd0aD3e0", "symbol": "KSD-HOUSE", "poolType": "CRYPTO_POOL", "lpTokenAddress": "0x5720c9F9D51A721b738a80efC9c1358dF394a668", "stakingPoolAddress": "0x93714AD0BBd45b50d3C0c3f2CDAE894403958c2D", "managerAddress": "0xf2CB805a5fE6dA501D31cd8C95ccD2F0d4824B72", "coins": ["0x4Fa62F1f404188CE860c8f0041d6Ac3765a72E67", "0x158BeFF8C8cDEbD64654ADD5F6A1d9937e73536c"], "coinsUnderlying": [], "adminFee": "0.2000000000", "swapMidFee": "0.0080000000", "swapOutFee": "0.0120000000", "deprecated": false, "liquidity": [{ "coin": "0x4Fa62F1f404188CE860c8f0041d6Ac3765a72E67", "amount": "9549.128255671074720508" }, { "coin": "0x158BeFF8C8cDEbD64654ADD5F6A1d9937e73536c", "amount": "1234514.871110727765631628" }], "tvl": "18936.486457842468356972", "lpTokenVirtualPrice": "1.042169767904777390", "lpTokenRealPrice": "0.181763518369215879", "lpTokenTotalSupply": "104181.997728371545427774", "priceOracle": "0.007785593223125825", "priceScale": "0.007646788252529844", "volume24hr": "350.154879508577258905", "volume24hrOnlySwap": "350.154879508577258905", "rewardFee24hr": "1.197318543815293975", "baseApr": "2.31", "stakingApr": "0.00", "user": null }, { "address": "0xc82f3B5EEaab67Be5c7Cb5C682bbEc3574cE494F", "symbol": "KLAY-oXRP", "poolType": "CRYPTO_POOL", "lpTokenAddress": "0xB29E85423b9905C1CCb2A5385c7738DA993870a0", "stakingPoolAddress": "0x90c9cF331C1eedBc8737D2C6Aa914Cb881BD4ba7", "managerAddress": "0x970EF938F726d191afbC0aF63f6CB4Db69E3A241", "coins": ["0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE", "0x9eaeFb09fe4aABFbE6b1ca316a3c36aFC83A393F"], "coinsUnderlying": [], "adminFee": "0.5000000000", "swapMidFee": "0.0020000000", "swapOutFee": "0.0025000000", "deprecated": false, "liquidity": [{ "coin": "0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE", "amount": "33156.804765532530098595" }, { "coin": "0x9eaeFb09fe4aABFbE6b1ca316a3c36aFC83A393F", "amount": "19132.367182" }], "tvl": "15283.204821473053930411", "lpTokenVirtualPrice": "1.005495388044491770", "lpTokenRealPrice": "0.609943436484145161", "lpTokenTotalSupply": "25056.757573405455917437", "priceOracle": "1.757174762281404410", "priceScale": "1.871386041447002979", "volume24hr": "328.714518255451517732", "volume24hrOnlySwap": "328.714518255451517732", "rewardFee24hr": "0.198036655069620338", "baseApr": "0.47", "stakingApr": "0.00", "user": null }, { "address": "0x1858f096c9B205B198676605364f423ABEc44d55", "symbol": "KSD-KOKOA", "poolType": "CRYPTO_POOL", "lpTokenAddress": "0xdc2cd392696a17bc0569bD1Bfc9532fd5a286b88", "stakingPoolAddress": "0xF90b771734F5b345f965dfd36D6A0B6fF3EcDE7c", "managerAddress": "0x30c27376A0044384594d767f2db92618E45524d5", "coins": ["0x4Fa62F1f404188CE860c8f0041d6Ac3765a72E67", "0xb15183D0d4D5E86ba702cE9bb7b633376e7db29f"], "coinsUnderlying": [], "adminFee": "0.2000000000", "swapMidFee": "0.0080000000", "swapOutFee": "0.0120000000", "deprecated": false, "liquidity": [{ "coin": "0x4Fa62F1f404188CE860c8f0041d6Ac3765a72E67", "amount": "6751.894552710291443635" }, { "coin": "0xb15183D0d4D5E86ba702cE9bb7b633376e7db29f", "amount": "2364881.486414388307508767" }], "tvl": "13398.133677763089004338", "lpTokenVirtualPrice": "1.040802035957363200", "lpTokenRealPrice": "0.110355725537926334", "lpTokenTotalSupply": "121408.595815524823104262", "priceOracle": "0.002834501065311678", "priceScale": "0.002848153290919290", "volume24hr": "593.806787380457574906", "volume24hrOnlySwap": "593.806787380457574906", "rewardFee24hr": "2.166217381347150452", "baseApr": "5.90", "stakingApr": "0.00", "user": null }, { "address": "0x8B4756D6F79b79f087e29b3671784D4FF3599BA4", "symbol": "oXRP-KSD", "poolType": "CRYPTO_POOL", "lpTokenAddress": "0xc56D91F3f8b554a2FF69fd6ec50a0eEe958B1c5a", "stakingPoolAddress": "0xe101CCaA3310Cd198241B71799ffE2ad5fF62820", "managerAddress": "0xf2223C09A2631B42F6dfC5B5bb2Dc4D9897AdcDb", "coins": ["0x9eaeFb09fe4aABFbE6b1ca316a3c36aFC83A393F", "0x4Fa62F1f404188CE860c8f0041d6Ac3765a72E67"], "coinsUnderlying": [], "adminFee": "0.5000000000", "swapMidFee": "0.0020000000", "swapOutFee": "0.0025000000", "deprecated": false, "liquidity": [{ "coin": "0x9eaeFb09fe4aABFbE6b1ca316a3c36aFC83A393F", "amount": "11268.377702" }, { "coin": "0x4Fa62F1f404188CE860c8f0041d6Ac3765a72E67", "amount": "4629.136618384411084807" }], "tvl": "9131.844704146198613153", "lpTokenVirtualPrice": "1.010390739839338376", "lpTokenRealPrice": "1.277313949553789913", "lpTokenTotalSupply": "7149.256224232318808209", "priceOracle": "2.483329045551879958", "priceScale": "2.543833884830752927", "volume24hr": "573.165135034211608382", "volume24hrOnlySwap": "573.165135034211608382", "rewardFee24hr": "0.310173844449487223", "baseApr": "1.24", "stakingApr": "0.00", "user": null }, { "address": "0x672dBfbD3953875f31cCbB8D9da3D3a38c3D191d", "symbol": "KLAY-WEMIX", "poolType": "CRYPTO_POOL", "lpTokenAddress": "0xD0cad737Cf704B2Ddf77E63160a94895bb896562", "stakingPoolAddress": "0xc8D7D3deA6e7fce0087cA6a244228e9107B9d819", "managerAddress": "0x7D4f425B2A9F4e91d0F1cFb274ce8209e36FB04c", "coins": ["0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE", "0x5096dB80B21Ef45230C9E423C373f1FC9C0198dd"], "coinsUnderlying": [], "adminFee": "0.5000000000", "swapMidFee": "0.0020000000", "swapOutFee": "0.0025000000", "deprecated": false, "liquidity": [{ "coin": "0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE", "amount": "9217.738586925657366748" }, { "coin": "0x5096dB80B21Ef45230C9E423C373f1FC9C0198dd", "amount": "1214.280880554659005176" }], "tvl": "4187.885558640095867779", "lpTokenVirtualPrice": "1.052722098460874408", "lpTokenRealPrice": "1.316965376723198993", "lpTokenTotalSupply": "3179.951145762209014637", "priceOracle": "7.335877556842539151", "priceScale": "6.463024895323350091", "volume24hr": "1219.357285596541965206", "volume24hrOnlySwap": "1219.357285596541965206", "rewardFee24hr": "0.738834715659497646", "baseApr": "6.44", "stakingApr": "0.00", "user": null }, { "address": "0x831716bC68eEA6B66495459089BdF6E640AEF6db", "symbol": "KOKO-TestWCD/4NUTS", "poolType": "META_POOL", "lpTokenAddress": "0x5a82Cc6cf99CBbdc199AC7F832EE659a86d16057", "extendedContractAddress": "0x3AE3F781A4Ca5D356b562d9825C1Ae92565A3696", "coins": ["0x4DAd4bC54D3fca70ffE16F89612330540A6B5A92", "0x22e3aC1e6595B64266e0b062E01faE31d9cdD578"], "coinsUnderlying": ["0x4DAd4bC54D3fca70ffE16F89612330540A6B5A92", "0x4Fa62F1f404188CE860c8f0041d6Ac3765a72E67", "0x5c74070FDeA071359b86082bd9f9b3dEaafbe32b", "0x754288077D0fF82AF7a5317C7CB8c444D421d103", "0xceE8FAF64bB97a73bb51E115Aa89C17FfA8dD167"], "adminFee": "0.6666666666", "swapFee": "0.0006000000", "deprecated": false, "liquidity": [{ "coin": "0x4DAd4bC54D3fca70ffE16F89612330540A6B5A92", "amount": "889.542298930795023807" }, { "coin": "0x22e3aC1e6595B64266e0b062E01faE31d9cdD578", "amount": "900.123600064086441452" }], "tvl": "1797.666558356951770418", "lpTokenVirtualPrice": "1.000383208170542137", "lpTokenRealPrice": "0.996281399754850072", "lpTokenTotalSupply": "1804.376312555162119293", "volume24hr": "10.406069776284456799", "volume24hrOnlySwap": "10.406069776284456799", "rewardFee24hr": "0.002082463433733369", "baseApr": "2.53", "user": null }, { "address": "0xf1b4705eD6F9A306188F229065DCd5376c8450D4", "symbol": "KLAY-KSP", "poolType": "CRYPTO_POOL", "lpTokenAddress": "0x1cE54D1DE574C620838a19294fef1aC70fC612a3", "stakingPoolAddress": "0x0BF7e3de3BBf194c855AC52382d5e656704d6f86", "managerAddress": "0x4DAb217686B915B1408B6e1E4484bc8DDf1b7c01", "coins": ["0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE", "0xC6a2Ad8cC6e4A7E08FC37cC5954be07d499E7654"], "coinsUnderlying": [], "adminFee": "0.5000000000", "swapMidFee": "0.0020000000", "swapOutFee": "0.0025000000", "deprecated": false, "liquidity": [{ "coin": "0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE", "amount": "3130.048704996123319776" }, { "coin": "0xC6a2Ad8cC6e4A7E08FC37cC5954be07d499E7654", "amount": "867.912192692341604027" }], "tvl": "1443.844495865960168417", "lpTokenVirtualPrice": "1.022430172510541369", "lpTokenRealPrice": "0.895599588794947251", "lpTokenTotalSupply": "1612.154040634041410794", "priceOracle": "3.682870046536455248", "priceScale": "3.694095173537073231", "volume24hr": "36.849803263042769072", "volume24hrOnlySwap": "36.849803263042769072", "rewardFee24hr": "0.020283025290804562", "baseApr": "0.51", "stakingApr": "0.00", "user": null }, { "address": "0x1509131EaDbE15A6c830b955d401164b641ba67b", "symbol": "KSD-oBUSD", "poolType": "BASE_POOL", "lpTokenAddress": "0x2ED5f3A3F2D84A4691cdf5927bCFE488A5265C3a", "stakingPoolAddress": "0x9a8C279ea74491AB6c3E65103007D26b4d2B74f7", "managerAddress": "0x01291DE3adC3837c23600A622e0881daE922Aed6", "coins": ["0x4Fa62F1f404188CE860c8f0041d6Ac3765a72E67", "0x210bC03f49052169D5588A52C317f71cF2078b85"], "coinsUnderlying": [], "adminFee": "0.6666666666", "swapFee": "0.0006000000", "deprecated": false, "liquidity": [{ "coin": "0x4Fa62F1f404188CE860c8f0041d6Ac3765a72E67", "amount": "1006.449277146645370047" }, { "coin": "0x210bC03f49052169D5588A52C317f71cF2078b85", "amount": "308.977647427607684806" }], "tvl": "1308.520175237686768108", "lpTokenVirtualPrice": "1.036997210740562064", "lpTokenRealPrice": "1.032553989918552067", "lpTokenTotalSupply": "1267.265622924863167174", "volume24hr": "322.568890048636996401", "volume24hrOnlySwap": "322.568890048636996401", "rewardFee24hr": "0.064552509528347162", "baseApr": "1.80", "stakingApr": "0.00", "user": null }, { "address": "0x1015Bd592A0370Cf838416f56bB15E4DDaA88D21", "symbol": "KSP-KSD", "poolType": "CRYPTO_POOL", "lpTokenAddress": "0x1a24ACb77D4EC42BF3506417B44EF53510e3C0Fd", "stakingPoolAddress": "0xf10468D62B498c8191ba66F8611d0E25750f51cF", "managerAddress": "0x9f2aE1FC0341a3A3A7AD9D4951bb98182e88004a", "coins": ["0xC6a2Ad8cC6e4A7E08FC37cC5954be07d499E7654", "0x4Fa62F1f404188CE860c8f0041d6Ac3765a72E67"], "coinsUnderlying": [], "adminFee": "0.5000000000", "swapMidFee": "0.0020000000", "swapOutFee": "0.0025000000", "deprecated": false, "liquidity": [{ "coin": "0xC6a2Ad8cC6e4A7E08FC37cC5954be07d499E7654", "amount": "157.627293902859274938" }, { "coin": "0x4Fa62F1f404188CE860c8f0041d6Ac3765a72E67", "amount": "133.918084378635656031" }], "tvl": "265.195744365140255035", "lpTokenVirtualPrice": "1.258720222787842812", "lpTokenRealPrice": "2.295900269095151267", "lpTokenTotalSupply": "115.508390296786661205", "priceOracle": "1.188843036871197538", "priceScale": "1.431996170671936322", "volume24hr": "5.156712313351068031", "volume24hrOnlySwap": "5.156712313351068031", "rewardFee24hr": "0.003209206096478292", "baseApr": "0.44", "stakingApr": "0.00", "user": null }, { "address": "0xBa80D34C72981DD2358330762c4Ff82d07278dC3", "symbol": "KSD-CELR_3NUTS", "poolType": "META_POOL", "lpTokenAddress": "0x84871F80C8fEdae324EC0FFea842278ACCBdB505", "extendedContractAddress": "0x603E0caD463722722480486532db241D1660B419", "coins": ["0x4Fa62F1f404188CE860c8f0041d6Ac3765a72E67", "0xf277F3E43F2a048eD127c43774E8933f52B69979"], "coinsUnderlying": ["0x4Fa62F1f404188CE860c8f0041d6Ac3765a72E67", "0x317F8d18FB16E49a958Becd0EA72f8E153d25654", "0x53bB26dc8C5EFC6c95C37155aCa487d1D043436a", "0x3c790b38f466514ffCB4230e7B2334e52B64c942"], "adminFee": "0.6666666666", "swapFee": "0.0010000000", "deprecated": false, "liquidity": [{ "coin": "0x4Fa62F1f404188CE860c8f0041d6Ac3765a72E67", "amount": "29.199508182533618369" }, { "coin": "0xf277F3E43F2a048eD127c43774E8933f52B69979", "amount": "144.816483597508188538" }], "tvl": "166.951598027853942725", "lpTokenVirtualPrice": "1.000379146557983789", "lpTokenRealPrice": "0.963417545940420932", "lpTokenTotalSupply": "173.291008380885829868", "volume24hr": "1.272807344215441718", "volume24hrOnlySwap": "1.272807344215441718", "rewardFee24hr": "0.000425123506198312", "baseApr": "0.11", "user": null }, { "address": "0x6c78F3F1806eC38afbf3574e65F6780c4c8b678B", "symbol": "CELR_3NUTS", "poolType": "BASE_POOL", "lpTokenAddress": "0xf277F3E43F2a048eD127c43774E8933f52B69979", "coins": ["0x317F8d18FB16E49a958Becd0EA72f8E153d25654", "0x53bB26dc8C5EFC6c95C37155aCa487d1D043436a", "0x3c790b38f466514ffCB4230e7B2334e52B64c942"], "coinsUnderlying": [], "adminFee": "0.6666666666", "swapFee": "0.0006000000", "deprecated": false, "liquidity": [{ "coin": "0x317F8d18FB16E49a958Becd0EA72f8E153d25654", "amount": "28.257767574219516687" }, { "coin": "0x53bB26dc8C5EFC6c95C37155aCa487d1D043436a", "amount": "71.717022" }, { "coin": "0x3c790b38f466514ffCB4230e7B2334e52B64c942", "amount": "44.897340" }], "tvl": "138.006445890479974158", "lpTokenVirtualPrice": "1.000095647493745740", "lpTokenRealPrice": "0.952775166688583512", "lpTokenTotalSupply": "144.846812464821157297", "volume24hr": "1.273695952805070812", "volume24hrOnlySwap": "0.000000000000000000", "rewardFee24hr": "0.000095539821384454", "baseApr": "0.03", "user": null }, { "address": "0x16310cc467D6059f0cCa609aa5b0C1Acd6376Eef", "symbol": "KSD-SYN_3NUTS", "poolType": "META_POOL", "lpTokenAddress": "0x04D85447c2B9e1f65ff759ebD8464d48e30Fe5e0", "managerAddress": "0x556bf6de374cA8605FA8e9DB41E0BBB791a340e1", "extendedContractAddress": "0x06DEd65472a5003a56aeb2bDb7997998A88BbdfE", "coins": ["0x4Fa62F1f404188CE860c8f0041d6Ac3765a72E67", "0xc6F08B0E59e59dD2085CE4AbC4Beef81AEc75270"], "coinsUnderlying": ["0x4Fa62F1f404188CE860c8f0041d6Ac3765a72E67", "0x078dB7827a5531359f6CB63f62CFA20183c4F10c", "0x6270B58BE569a7c0b8f47594F191631Ae5b2C86C", "0xd6dAb4CfF47dF175349e6e7eE2BF7c40Bb8C05A3"], "adminFee": "0.6666666666", "swapFee": "0.0010000000", "deprecated": false, "liquidity": [{ "coin": "0x4Fa62F1f404188CE860c8f0041d6Ac3765a72E67", "amount": "11.482954506279476341" }, { "coin": "0xc6F08B0E59e59dD2085CE4AbC4Beef81AEc75270", "amount": "51.464034562815391730" }], "tvl": "61.535140486971212798", "lpTokenVirtualPrice": "1.043301871865499289", "lpTokenRealPrice": "1.009244064162260243", "lpTokenTotalSupply": "60.971515882086931790", "volume24hr": "0.656624871231365371", "volume24hrOnlySwap": "0.656624871231365371", "rewardFee24hr": "0.000219094051172068", "baseApr": "0.16", "user": null }, { "address": "0x53B9d26dE6A315CB6672fEBab37a5Ac57e8e6316", "symbol": "SYN_3NUTS", "poolType": "BASE_POOL", "lpTokenAddress": "0xc6F08B0E59e59dD2085CE4AbC4Beef81AEc75270", "managerAddress": "0xf6d1eF40a0f9E798EC8d6ebe3AFc10c1a16B5f77", "coins": ["0x078dB7827a5531359f6CB63f62CFA20183c4F10c", "0x6270B58BE569a7c0b8f47594F191631Ae5b2C86C", "0xd6dAb4CfF47dF175349e6e7eE2BF7c40Bb8C05A3"], "coinsUnderlying": [], "adminFee": "0.6666666666", "swapFee": "0.0006000000", "deprecated": false, "liquidity": [{ "coin": "0x078dB7827a5531359f6CB63f62CFA20183c4F10c", "amount": "21.176402539139898345" }, { "coin": "0x6270B58BE569a7c0b8f47594F191631Ae5b2C86C", "amount": "1.836471" }, { "coin": "0xd6dAb4CfF47dF175349e6e7eE2BF7c40Bb8C05A3", "amount": "33.760596" }], "tvl": "54.306648990124763430", "lpTokenVirtualPrice": "1.017136877737888308", "lpTokenRealPrice": "0.974284955464290761", "lpTokenTotalSupply": "55.740005719625624060", "volume24hr": "0.641286492700326984", "volume24hrOnlySwap": "0.000000000000000000", "rewardFee24hr": "0.000094601774535400", "baseApr": "0.06", "user": null }, { "address": "0xe7acdCc0a917cAB497b0D72F7ec7A9da0100D638", "symbol": "USDK-4NUTS", "poolType": "META_POOL", "lpTokenAddress": "0x0FD58C80fbb9728093c1eA041fCfD3EE723FF696", "stakingPoolAddress": "0xc8Ee294F7fec9970D5Ebf37359eF1816DCb52B8E", "managerAddress": "0xe8b8Ead5E4B977168F2Aa2CC0fd675147321C31c", "extendedContractAddress": "0x9ba7fCb5334FbC694D81133a809F7fe7d41BA438", "coins": ["0xd2137Fdf10bD9e4E850C17539eB24cfe28777753", "0x22e3aC1e6595B64266e0b062E01faE31d9cdD578"], "coinsUnderlying": ["0xd2137Fdf10bD9e4E850C17539eB24cfe28777753", "0x4Fa62F1f404188CE860c8f0041d6Ac3765a72E67", "0x5c74070FDeA071359b86082bd9f9b3dEaafbe32b", "0x754288077D0fF82AF7a5317C7CB8c444D421d103", "0xceE8FAF64bB97a73bb51E115Aa89C17FfA8dD167"], "adminFee": "0.6666666666", "swapFee": "0.0006000000", "deprecated": false, "liquidity": [{ "coin": "0xd2137Fdf10bD9e4E850C17539eB24cfe28777753", "amount": "237967628488.157010030691957456" }, { "coin": "0x22e3aC1e6595B64266e0b062E01faE31d9cdD578", "amount": "3.406359633385161098" }], "tvl": "10.357780389871047960", "lpTokenVirtualPrice": "1.000000000000000000", "lpTokenRealPrice": "0.005057738051683251", "lpTokenTotalSupply": "2047.907638558684628833", "volume24hr": "0.000000000000000000", "volume24hrOnlySwap": "0.000000000000000000", "rewardFee24hr": "0.000000000000000000", "baseApr": "2.48", "stakingApr": "0.00", "user": null }, { "address": "0x49cebd5ad40359F5Fa4126419c86B5721a1d7F75", "symbol": "KASH3NUTS", "poolType": "BASE_POOL", "lpTokenAddress": "0x8187b3F5d623B18aCe3951E443A99bCD3dC3eeB1", "stakingPoolAddress": "0x352BA5D409BdF5Ee35264524402313b755f51670", "managerAddress": "0xadBB263a8A2f8E33bB9baBca14115b0e6194378d", "coins": ["0xce40569d65106C32550626822B91565643c07823", "0x5c74070FDeA071359b86082bd9f9b3dEaafbe32b", "0xceE8FAF64bB97a73bb51E115Aa89C17FfA8dD167"], "coinsUnderlying": [], "adminFee": "0.6666666666", "swapFee": "0.0006000000", "deprecated": true, "liquidity": [], "tvl": "0.000000000000000000", "lpTokenVirtualPrice": "0.000000000000000000", "lpTokenRealPrice": "0.000000000000000000", "lpTokenTotalSupply": "0.000000000000000000", "volume24hr": "0.000000000000000000", "volume24hrOnlySwap": "0.000000000000000000", "rewardFee24hr": "0.000000000000000000", "baseApr": "0.00", "stakingApr": "0.00", "user": { "balance": "0.000000000000000000", "value": "0.000000000000000000" } }, { "address": "0x44ACE4b2C239F3A34866bB7e6149E6bA9eb4110E", "symbol": "KSD-KASH", "poolType": "BASE_POOL", "lpTokenAddress": "0xBDc4Abb3E4b8DE77c8889318dfB98A8bcd81A8c4", "stakingPoolAddress": "0x72f8246F9Ea937fa332B1c1E69Caa934e7296312", "managerAddress": "0xf8b8e78B05bC10e25ae7e6575D44Ca02Dee7A5ff", "coins": ["0x4Fa62F1f404188CE860c8f0041d6Ac3765a72E67", "0xce40569d65106C32550626822B91565643c07823"], "coinsUnderlying": [], "adminFee": "0.6666666666", "swapFee": "0.0006000000", "deprecated": true, "liquidity": [], "tvl": "0.000000000000000000", "lpTokenVirtualPrice": "0.000000000000000000", "lpTokenRealPrice": "0.000000000000000000", "lpTokenTotalSupply": "0.000000000000000000", "volume24hr": "0.000000000000000000", "volume24hrOnlySwap": "0.000000000000000000", "rewardFee24hr": "0.000000000000000000", "baseApr": "0.00", "stakingApr": "0.00", "user": { "balance": "0.000000000000000000", "value": "0.000000000000000000" } }, { "address": "0x048915901421F8C0ac9eDA93A086F2D90Df6cb0B", "symbol": "oETH-KSD", "poolType": "CRYPTO_POOL", "lpTokenAddress": "0xF631C84c1d2FF368783222AF29F46BF628eb5Cbc", "managerAddress": "0x523C201736f5f3d5b8CF4A2a4D2470DF29bdFFd9", "coins": ["0x34d21b1e550D73cee41151c77F3c73359527a396", "0x4Fa62F1f404188CE860c8f0041d6Ac3765a72E67"], "coinsUnderlying": [], "adminFee": "0.5000000000", "swapMidFee": "0.0020000000", "swapOutFee": "0.0030000000", "deprecated": true, "liquidity": [], "tvl": "0.000000000000000000", "lpTokenVirtualPrice": "0.000000000000000000", "lpTokenRealPrice": "0.000000000000000000", "lpTokenTotalSupply": "0.000000000000000000", "volume24hr": "0.000000000000000000", "volume24hrOnlySwap": "0.000000000000000000", "rewardFee24hr": "0.000000000000000000", "baseApr": "0.00", "user": { "balance": "0.000000000000000000", "value": "0.000000000000000000" } }, { "address": "0x8cc8029AA4020a0C3f6DAbbD9A7CD499321Be917", "symbol": "KSD-USDK", "poolType": "BASE_POOL", "lpTokenAddress": "0x65D5731Ef9FF6C922Dc1Ee3dbfEcc2cd025F8f4F", "stakingPoolAddress": "0x3867BCb006B2c04F47d665bd59D226990094E599", "managerAddress": "0x4D6ed2fBE0111dF6eA7863F7a096FC2379Ab6ac9", "coins": ["0x4Fa62F1f404188CE860c8f0041d6Ac3765a72E67", "0xd2137Fdf10bD9e4E850C17539eB24cfe28777753"], "coinsUnderlying": [], "adminFee": "0.6666666666", "swapFee": "0.0006000000", "deprecated": true, "liquidity": [], "tvl": "0.000000000000000000", "lpTokenVirtualPrice": "0.000000000000000000", "lpTokenRealPrice": "0.000000000000000000", "lpTokenTotalSupply": "0.000000000000000000", "volume24hr": "0.000000000000000000", "volume24hrOnlySwap": "0.000000000000000000", "rewardFee24hr": "0.000000000000000000", "baseApr": "0.00", "stakingApr": "0.00", "user": { "balance": "0.000000000000000000", "value": "0.000000000000000000" } }] }

export const fetchKokonutSwapInfo$ = () => from(
  fetch("https://prod.kokonut-api.com/pools")
    .then((res) => res.json())
    .catch(() => {
      return KOKONUT_DUMMY_DATA
    })
).pipe(
  timeout(2000),
  catchError((err) => {
    console.log(err, '@err')
    return of(KOKONUT_DUMMY_DATA)
  }),
  map((result) => {
    if (result.statusCode == 500) {
      return KOKONUT_DUMMY_DATA
    }

    return result
  }),
  map(({ pools }) => {
    
    return (pools || []).reduce((acc, cur) => {

      acc.tokenPrices[cur.lpTokenAddress.toLowerCase()] = Number(cur.lpTokenRealPrice)
      acc.aprs[cur.lpTokenAddress.toLowerCase()] = {
        'miningAPR': Number(cur.stakingApr) * 0.7,
        'tradingFeeAPR': Number(cur.baseApr),
        'airdropAPR': 0,
      }

      acc.liquidities[cur.lpTokenAddress.toLowerCase()] = cur.liquidity.map(({ coin, amount }) => {
        const token = coin.toLowerCase() == "0x" + "e".repeat(40)
          ? tokenList.KLAY
          : addressKeyFind(tokenListByAddress, coin)

        if (!token) return {}

        return {
          token,
          amount,
          lpTVL: cur.tvl,
        }
      })

      return acc
    }, {
      tokenPrices: {},
      aprs: {},
      liquidities: {}
    })
  })
)

export const tokenPrices$ = new BehaviorSubject({})

export const liquidities$ = new BehaviorSubject({})

window.tokenPrices$ = tokenPrices$
